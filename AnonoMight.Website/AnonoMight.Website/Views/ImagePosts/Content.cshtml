@model AnonoMight.Website.Models.ImagePostModel
@using PagedList.Mvc
@{
    ViewBag.Title = Model.SiteInfo.Title;
}

@Html.Hidden("SiteName", Model.SiteInfo.Name)

<h2>@Model.SiteInfo.Title</h2>

<div class="row site-header">
    <div class="col-md-2"><img id="ProfileImage" src="@Url.Action("GetSiteImage", "Site", new  { SiteName = Model.SiteInfo.Name})" /></div>
    <div class="col-md-10">@Model.SiteInfo.Description</div>
</div>
@if (Model.ContentList.PageNumber == 1)
{
    <div class="row" id="Container">
        <div class="col-md-8">

            <div id="SelectedImage" class="form-group">
                <pre id="console" class="col-md-12">...</pre>
            </div>
        </div>
        <div class="col-md-2">
            <div class="form-group">
                <input type="button" id="SelectImage" class="col-md-12 btn btn-default" value="..." />
            </div>
        </div>
        <div class="col-md-2">
            <div class="form-group">
                <input type="button" id="UploadImage" class="col-md-12 btn btn-default" value="Upload" />
            </div>
        </div>
    </div>
}
<div class="table" id="Posts">
    @foreach (var item in Model.ContentList)
{
    <div class="row imageRow" data-id="@item.Id">
        <div class="col-md-12 " >
            <div class="imageContainer">
                <div><img class="img-rounded" src="data:image/jpg;base64,@Convert.ToBase64String(item.Link)" /></div>
                <div>
                    <div class="date">@item.TimeStamp.ToString("dd MMMM yyyy HH:mm") </div>
                    <div class="report"><a data-toggle="modal" data-target="#reportModal">Report</a></div>
                    <div class="clear"></div>
                </div>

            </div>

        </div>
    </div>
}

</div>

    Page @(Model.ContentList.PageCount < Model.ContentList.PageNumber ? 0 : Model.ContentList.PageNumber) of @Model.ContentList.PageCount
    @Html.PagedListPager(Model.ContentList, page => string.Format("/{1}?page={0}", page, Model.SiteInfo.Name))

    @section scripts {
        @if (Model.ContentList.PageNumber == 1)
        {
            <script type="text/javascript" src="Scripts/plupload/plupload.full.min.js"></script>

            <script src="~/Scripts/jquery.signalR-2.0.1.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
            <script src="~/signalr/hubs"></script>
            <script type="text/javascript">
    // Custom example logic
    var site = '@(Model)';

                $(document).ready(function () {
                    var uploader = new plupload.Uploader({
                        runtimes: 'html5,flash,silverlight,html4',
                        browse_button: 'SelectImage', // you can pass in id...
                        container: document.getElementById('Container'), // ... or DOM Element itself
                        url: 'Upload',
                        flash_swf_url: 'Scripts/plupload/Moxie.swf',
                        silverlight_xap_url: 'Scripts/plupload/Moxie.xap',
                        resize: {
                            width: 500,
                            height: 500
                        },
                        filters: {
                            max_file_size: '6mb',

                            mime_types: [
                                { title: "Image files", extensions: "jpg,png" }
                            ]
                        },

                        init: {
                            PostInit: function () {
                                $('#UploadImage').on('click', function () {
                                    uploader.start();
                                    return false;
                                });
                            },

                            FilesAdded: function (up, files) {
                                plupload.each(files, function (file) {

                                    $('#SelectedImage pre').html(
                                        '<div id="' + file.id + '">' + file.name + ' (' + plupload.formatSize(file.size) + ') <b></b></div>')

                                });
                            },

                            UploadProgress: function (up, file) {
                                $('#console').html('<span>' + file.percent + "%</span>");
                            },

                            Error: function (up, err) {
                                $('#console').html("\nError #" + err.code + ": " + err.message);
                            }
                        }
                    });

                    uploader.bind('FilesAdded', function (up, files) {
                        while (up.files.length > 0) {
                            up.removeFile(up.files[0]);
                        }
                    });
                    uploader.init();


                    //<img src="TerrificTurd/PostedImage/8BD08C92-5EED-472A-9265-A8BABCB98A9E" />

                    var chat = $.connection.notificationHub;
                    // Create a function that the hub can call back to display messages.
                    chat.client.postImageReceived = function (event) {
                        // Add the message to the page.
                        if ($("#Posts .row").length >= 10)
                            $("#Posts .row").last().remove();


                        var row =
                        '<div class="row imageRow" data-id="' + event.Id + '">' +
                            '<div class="col-md-12">' +
                                '<div class="imageContainer">' +
                                    '<div><img class="img-rounded" src="data:image/jpg;base64,' + event.Image + '"/></div>' +
                                    '<div>' +
                                        '<div class="date">Now</div>' +
                                        '<div class="report"><a data-toggle="modal" data-target="#reportModal">Report</a></div>' +
                                        '<div class="clear"></div>' +
                                    '</div>' +

                                '</div>' +

                           '</div>' +
                        '</div>'

                        $('#Posts').prepend(row);
                    };
                    // Get the user name and store it to prepend to messages.
                    // Set initial focus to message input box.
                    $('#message').focus();
                    // Start the connection.

                    var siteName = '@(Model.SiteInfo.Name)';
        $.connection.hub.start().done(function () {
            chat.server.addGroup({ siteName: siteName });
        });
    });

            </script>


        }


    }


